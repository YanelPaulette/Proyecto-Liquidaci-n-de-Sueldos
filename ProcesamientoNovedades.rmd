---
title: "Anexo 1: Liquidación de Sueldos"
subtitle: "Conceptos Básicos"
author: "Yanel Paulette y Diego Sipes"
date: '\today'
linkcolor: blue
urlcolor: blue
output:
  html_document:
    theme: spacelab
    toc: true
    toc_float: true
    code_folding: hide
    code_download: true

---

Nota: Voy trabajando este documento, volcando ideas para ir armando el codigo. 

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

#### Procesamiento de Novedades de liquidacion  #####

##Objetivos
completar

## Destinatarios
completar : rrhh q trabajen con novedades de liq 

## Procedimiento

Para comenzar, se deben realizar configuraciones iniciales, las cuales iremo detallando a continuación: 


## Pasos (ver)

Incorporamos las librerias a utilizar

```{r}
library(flexdashboard)
library(tidyverse)      # Transformar y limpiar datos
library(googlesheets4)  # Leer datos desde Google Sheets
library(gargle)         # Corregir lectura de símbolos especiales desde Google Sheets
library(gt)             # Dar formato a las tablas
library(extrafont)      # Permite utilizar otras fuentes en los gráficos y salidas
library(ggthemes)       # Amplía las posibilidades estéticas de ggplot2
library(scales)         # Permite cambiar los formatos de decimales, de porcentajes, etc.
library(ggalt)          # Nuevos tipos de geom para ggplot2. Para realizar el gráfico de gap salarial
library(ggplot2)
library(funModeling)    # Para explorar datos y modelos
library(forcats)
library(DT)
library(kableExtra)
library(tm)
library(expss)
library(lubridate) # para las fechas
library(datos)
library( hms)


```

Creamos objetos que vamos a utlizar en diversas oportunidades y solo debemos invocarlos: 

```{r}
# Estilo limpio sin líneas de fondo
estilo <- theme(panel.grid = element_blank(),
                plot.background = element_rect(fill = "#FBFCFC"),
                panel.background = element_blank(),
                text = element_text(family = "Roboto"))

# Estilo limpio con líneas de referencia verticales en gris claro
estilov <- theme(panel.grid = element_blank(),
                 plot.background = element_rect(fill = "#FBFCFC"),
                 panel.background = element_blank(),
                 panel.grid.major.x = element_line(color = "#AEB6BF"),
                 text = element_text(family = "Roboto"))

# Estilo limpio con líneas de referencia horizontales en gris claro
estiloh <- theme(panel.grid = element_blank(),
                 plot.background = element_rect(fill = "#FBFCFC"),
                 panel.background = element_blank(),
                 panel.grid.major.y = element_line(color = "#AEB6BF"),
                 text = element_text(family = "Roboto"))

#  objetos para formatear las etiquetas numéricas de los ejes x e y
eje_x_n <- scale_x_continuous(labels = comma_format(big.mark = ".", decimal.mark = ","))

eje_y_n <- scale_y_continuous(labels = comma_format(big.mark = ".", decimal.mark = ","))

#colores

azul <- "#344D7E"
verde <-  "#4A9FC7"
rosa1 <- "#B95192"
rosa2 <- "#EE5777"
naranja <- "#FF764C"
amarillo <- "#FFA600"
gris <- "#75838F"
lila <- "#755395"
rojo <- "#943126"
fuente <- "Fuente: Elaboración propiaS"
```

##### Primer Ejemplo de Novedades #### 


Incorporamos las bases de datos a utilizar, desde el drive. 

```{r}
original <- read_sheet("1_AUDkMkG80ribPRl76M2KWtqwDk_hWiM7IOzKSZ6N14") # 1° hoja
egreso <- read_sheet("1_AUDkMkG80ribPRl76M2KWtqwDk_hWiM7IOzKSZ6N14", sheet = "2") #la 2° hoja

```

Comenzamos con algunas limpiezas;: 

```{r}
#agregar puntos a las  columnas:


limpios <- make.names(colnames(original)) #agregar puntos columnas
colnames(original) <- limpios
rm(limpios) # borro objeto

#agregar puntos a las  columnas:


limpios <- make.names(colnames(egreso)) #agregar puntos columnas
colnames(egreso) <- limpios
rm(limpios) # borro objeto

```



Consultamos el tamaño de nuestro dataset. En este caso tiene una dimension de `tamaño`, con  `columnas` y con  `filas`. Cada fila representa una persona, y cada columna una variable. 


Vemos ahora,  si las columnas tienen nombres inadecuados para  trabajar  y acto seguido los modificamos

```{r}
names(original)
```

Cambiamos los nombres de las columnas con la funcion "Rename"

```{r}

Novedades <- original %>% 
  rename("Hs.Extras.50%" = "X50.")%>% 
  rename("Hs.Extras.100%" = "X100.")%>% 
  rename("Hs.Feriado" = "X100..FT")%>% 
  rename("Hs.Noct" = "Noc")%>% 
  rename("Hs.Noct.50%" = "Noc.50.")%>% 
  rename("Hs.Noct.100%" = "Noc.100.")%>%
  rename("Hs.Viaje" = "Horas.Viaje")%>%
  rename("2°Vianda" = "D.Vianda") %>%
  rename("Centro.Costo" = "CC") 


```


Volvemos a consultar el nuevo dataset creado a fin de confirmar los nuevos nombres, con la funcion "View":

```{r}
view(Novedades)
```

Por el alacance del presente proyecto, solo  vamos a trabajar con algunas variables,  por ello seleccionamos las variables  deseadas: 

```{r}
Novedades2<- Novedades%>% 
  select(Legajo, Centro.Costo,  Activo, Convenio, `Hs.Extras.50%`, `Hs.Extras.100%`, Hs.Noct, Enfermedad, Vacaciones )
```

¿ Qué tipo de análisis podemos hacer?

Aqui tenemos que pensar qué datos son relevantes para el negocio. 
Mirando con dichos ojos, qué analsis podemos hacer con  poca intervencion de código. 

En primer lugar podemos conocer cantidades. 

Podemos consultar cual es la nomina  que tiene actualmente la compañia. 

```{r}
Nomina<- Novedades %>% 
  select(Activo) %>%
  mutate(cuenta = 1) %>% 
  group_by(Activo) %>% 
  summarise(Cuenta = sum(cuenta)) %>% 
  arrange(-Cuenta)

Nomina

```

Podemos mejorar la visualización con el paquete {Kable}

* Aplausos para la maravilla del parametro TIP*

```{r}

Nomina$TIP <- c("Podemos destacar algo")

Nomina%>% 
  mutate(Cuenta=text_spec(Cuenta, "html", tooltip=TIP)) %>% 
    select(Activo,Cuenta) %>% kable("html", escape=F) %>% 
    kable_styling(full_width = TRUE, bootstrap_options = c("striped","hover","condensed" )) %>% 
row_spec(0, bold=T, color="white", background = azul)



```



Ahora veamos de aquellos que son baja, cuales fueron los motivos de egreso. 

Es posible que dicha información no la tengamos en la misma tabla, en ese caso, tendremos que hacer  unos pasos adicionales. 

A continuación vamos a ver cómo relacionamos dos tablas. Para hacerlo, necesitamos 1 elemento en común: en nuestro caso será el legajo. 

El resultado:  una nueva tabla con la información combinada.

Primero: consultamos los nombres de las columnas: 
```{r}
names(egreso)
names(original)

```

Primero, seleccionamos las columnas de la segunda hoja, con las que vamos a trabajar: 

```{r}
egreso2<- egreso%>%
  select(Legajo, Fecha.de.Ingreso, Fecha.de.Egreso, Motivo.de.Egreso)

```

Luego, unimos las tablas por la columna en comun "Legajo" y seleccionamos las columnas deseadas: 

```{r}

egreso3 <- left_join(original, egreso, by = "Legajo")

egreso3<-egreso3%>%
  select(Legajo:Convenio, Motivo.de.Egreso) %>%   # Usamos rangos, y columnas independientes
  filter(Activo=="NO")  %>%  
  mutate(cuenta = 1) %>% 
  group_by(Motivo.de.Egreso) %>% 
  summarise(Cuenta = sum(cuenta)) %>% 
  arrange(-Cuenta)



```

Y luego presentamos la información  en una tabla: 




```{r}

egreso3$TIP <- c("Egresos del mes") 

egreso3%>% 
  mutate(Cuenta=text_spec(Cuenta, "html", tooltip=TIP)) %>% 
    select(Motivo.de.Egreso,Cuenta) %>% kable("html", escape=F) %>% 
    kable_styling(full_width = TRUE, bootstrap_options = c("striped","hover","condensed" )) %>% 
row_spec(0, bold=T, color="white", background = azul)

```

En el cuadro anterior, vemos que los nombres de los motivos de egreso, se repiten, lo cual implica que unifiquemos nombres, lo cual hacemos con la funcion "fct_collapse":

```{r}
 egreso3<-  egreso2 %>%
 mutate(Motivo.de.Egreso = fct_collapse(Motivo.de.Egreso, "Desp C/C" = c("Desp C/ Causa","Despido con causa", "Despido C/C")),
        Motivo.de.Egreso = fct_collapse(Motivo.de.Egreso, "Desp S/C" = c("Despido sin C","Despido sin causa", "Despido S/C")))
```

AHora si volvemos a presentar la información en una tabla: 


```{r}
egreso3$TIP <- c("Egresos del mes")


egreso3 %>%   # Usamos rangos, y columnas independientes
  mutate(cuenta = 1) %>% 
  group_by(Motivo.de.Egreso) %>% 
  summarise(Cuenta = sum(cuenta)) %>% 
  arrange(-Cuenta)%>%
  kable("html", escape=F) %>% 
    kable_styling(full_width = TRUE, bootstrap_options = c("striped","hover","condensed" )) %>% 
row_spec(0, bold=T, color="white", background = azul)

```

Por último quisieramos saber la cantidad de licencias que tuvimos en el mes. (ver, queda horrible)


```{r}
Novedades2%>% 
  select(Legajo, Enfermedad, Vacaciones ) %>% 
  filter(Enfermedad!=0  | Vacaciones!=0) %>%    # operador or
  mutate(cuenta = 1) %>% 
  group_by(Enfermedad,Vacaciones)%>% 
  summarise(Cuenta = sum(cuenta)) %>% 
  arrange(-Cuenta)



```
##### Segundo Ejemplo de Novedades #### 



Incorporamos las bases de datos a utilizar, desde el drive. 

```{r}
original2 <- read_sheet("1JOrvsv_C6Kn7tCdaAwqDNJjUC2MEdaZ8Ivj3z6rH3ds", skip=1) # 1° hoja, salto la hoja 1

```

para manipularlo: 


```{r}
n2 <-original2
#rm(n2)
```


Pasar a Mayusculas: 

```{r}

n2 <- mutate_if(n2, is.factor, toupper)
n2 <- mutate_if(n2, is.character, toupper)

```



Pivotear: 

```{r}
 
n2<- n2 %>%
  pivot_longer(cols = c(`16/12/2021`:`31/12/2021`), names_to = "Fecha", values_to = "Horario")

```

Eliminamos la primer tanda de columnas: 

```{r}
 
n2<- n2 %>%
  select(everything()) %>%
  select(-Sem1:-Sem5)

```




Fechas

```{r}
n2$Fecha <- format(as.Date(n2$Fecha, format = "%d/%m/%Y"), "%m-%d-%Y") # Cambie formato 

n2 <- n2 %>% 
  mutate(Fecha = mdy(Fecha))

glimpse(n2)

```


Modificamos las columnas; 

```{r}

limpios <- make.names(colnames(n2)) 
colnames(n2) <- limpios
rm(limpios)
head(n2)
```
Cambiamos los nombres a las columnas: 


```{r}


n2 <- n2 %>% 
  rename("Legajo" = "N.Legajo")%>%
  rename("Agrupación1" = "Mens...Jorn")%>%
  rename("Agrupación2" = "Sector")

head(n2)
```


Pasamos a factor las catgeoria que despues vamos a categorizar.. y confirmamos el cambio: 

```{r}
n2 <- n2 %>%
mutate(`Agrupación1` = factor(`Agrupación1`))%>%
mutate(`Agrupación2` = factor(`Agrupación2`))

head(n2)
```

Unimos las columnas de Nombre y Apellido y eliminamos dichas columnas, individuales: 


```{r}


n2<- within(n2, 'Apynom' <- paste(Apellido, Apellido, sep=' '))


n2<- n2 %>%
  select('Legajo', 'Apynom',everything()) %>%
  select(-Apellido, -Nombre) %>%
  arrange(Apynom)
head(n2)


```
Le agregamos el dia de la semana

```{r}

n2 <- n2 %>%
mutate(`Dia` = wday(n2$Fecha,label = TRUE, abbr = FALSE))

n2



```

Licencias: 
```{r}
n2<- n2 %>%
  mutate(Licencia=Horario)

n2$Licencia<-as.factor(n2$Licencia)


n2<- n2%>%
  mutate(Licencia= str_trim(Licencia,side = "both"),
         Licencia =  fct_collapse(Licencia, "Vacaciones" = "VAC"),
         Licencia =  fct_collapse(Licencia, "Enfermedad" = "ENFERMO"),
         Licencia =  fct_collapse(Licencia, "Aus C/A" = "AUS C/ AVISO"),
         Licencia =  fct_collapse(Licencia, "Aus C/P" = "AUS C/ PERM"),
         Licencia =  fct_collapse(Licencia, "Aus S/A" = "AUS S/ AVISO"),
         Licencia =  fct_collapse(Licencia, "Vacunación" = "VACUNACION"),
         Licencia =  fct_collapse(Licencia, "Calent" = c("CALENT 4 HS","CALENT 4HS")))


#Esto es horrible,  ver como hacerlo bien: 

n2$Licencia<- gsub("06 A 12", " ", n2$Licencia)
n2$Licencia<- gsub("06 A 14", " ", n2$Licencia)
n2$Licencia<- gsub("06 A 16", " ", n2$Licencia)
n2$Licencia<- gsub("06 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("07 A 16", " ", n2$Licencia)
n2$Licencia<- gsub("14 A 22", " ", n2$Licencia)
n2$Licencia<- gsub("14 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("14 A 18:49", " ", n2$Licencia)
n2$Licencia<- gsub("08:02 A 14", " ", n2$Licencia)
n2$Licencia<- gsub("14 A 18:49", " ", n2$Licencia)
n2$Licencia<- gsub("14 A 18:49", " ", n2$Licencia)
n2$Licencia<- gsub("06:55 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("06 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("18 A 06", " ", n2$Licencia)
n2$Licencia<- gsub("06:40 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("06:39 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("09 A 17", " ", n2$Licencia)
n2$Licencia<- gsub("22 A 06", " ", n2$Licencia)
n2$Licencia<- gsub("22 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("06:14 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("06:45 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("18 A 05", " ", n2$Licencia)
n2$Licencia<- gsub("07 A 14", " ", n2$Licencia)
n2$Licencia<- gsub("09 A 14", " ", n2$Licencia)
n2$Licencia<- gsub("11 A 21", " ", n2$Licencia)
n2$Licencia<- gsub("18:20 A 06", " ", n2$Licencia)
n2$Licencia<- gsub("06 A 08:59", " ", n2$Licencia)
n2$Licencia<- gsub("11 A 21", " ", n2$Licencia)
n2$Licencia<- gsub("06:14 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("06:45 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("10 A 22", " ", n2$Licencia)
n2$Licencia<- gsub("06:14 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("06:45 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("10 A 22", " ", n2$Licencia)
n2$Licencia<- gsub("06:25 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("21:40 A 06", " ", n2$Licencia)
n2$Licencia<- gsub("18 A 21:02", " ", n2$Licencia)
n2$Licencia<- gsub("10 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("06:38 A 12", " ", n2$Licencia)
n2$Licencia<- gsub("12 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("10 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("06:38 A 12", " ", n2$Licencia)
n2$Licencia<- gsub("06:38 A 12", " ", n2$Licencia)
n2$Licencia<- gsub("09 A 18", " ", n2$Licencia)
n2$Licencia<- gsub("07:50 A 18", " ",n2$Licencia)
n2$Licencia<- gsub("10 A 14", " ", n2$Licencia)
n2$Licencia<- gsub("10 A 14", " ", n2$Licencia)
n2$Licencia<- gsub("10 A 20", " ", n2$Licencia)
n2$Licencia<- gsub("18:40 A 06", " ", n2$Licencia)
n2$Licencia<- gsub("14 A 18:49", " ", n2$Licencia)
n2$Licencia<- gsub("20 A 06", " ", n2$Licencia)




```

Apertura horaria

```{r}
n2 <- n2 %>%
  mutate%>%
    separate(Horario,c("Entrada","Salida"), sep=" A ",extra="merge",fill="left")
n2$Entrada<-as.numeric(n2$Entrada)
n2$Salida<-as.numeric(n2$Salida)
glimpse(n2)

```

horas normales 

```{r}
hs_semana_jornal<- 8
hs_sabado_jornal<- 6

```

Codifico los dias

```{r}

n2<- n2 %>% 
  mutate(
    `cod` = case_when( 
       Dia == "domingo" ~ 1,
       Dia == "sábado" ~ 3,
      TRUE ~ 2
    )
  )

```

Diferencia horas extras: 

```{r}
#1=Domingo
#2=Semana
#3=sabado (no le pongo nada y queda en cero)

n2<-n2 %>%
mutate(hs50 = if_else(cod == 2& Salida<Entrada, ((24-Entrada)+(0+Salida))-hs_semana_jornal,(if_else(cod == 2& Entrada<Salida, (Salida-Entrada)-hs_semana_jornal, 0))),
       hs100 =if_else(cod == 1& Salida<Entrada, (24-Entrada)+(0+Salida),(if_else(cod == 1& Entrada<Salida, (Salida-Entrada), 0))))

```

diferencia de hs nocturnas

```{r}

n2 %>%
  select(Legajo, Fecha, Entrada, Salida)%>%
mutate(Noc = if_else(Salida >21, (Salida-21),
             if_else(Entrada >21,(24-Entrada)+(0+Salida),0))) # se podria trabajar aun mas
                     
                  

```

